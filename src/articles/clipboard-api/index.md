---
title: "Clipboard API"
date: 2021-03-10
author: pavel-mineev
editors:
    - vadim-makeev
layout: article.njk
tags:
preview: ""
hero:
    src: ""
    alt: ""
    contain: true
    background: "#e1e4eb"
---

### История

Возможность помещать данные в буфер обмена существует в браузере достаточно давно и имеет не очень очевидный API — с помощью выполнения команд `copy` или `write` через функцию `document.execCommand()`, кроме того это API является синхронным. Неудобность этого API сподвигла разработчиков к написанию небольших библиотек, которые помогают пользоваться этой возможностью с помощью более удобного программного интерфейса. А консорциум задумался над разработкой нового, более удобного способа взаимодействия с Clipboard API. Так в декабре 2016 года [был опубликован первый черновик](https://github.com/w3c/clipboard-apis/commit/3ffdbba8580e0096aa7d492d49e1309001d25162) современного API. В данный же момент эта возможность реализована всеми браузерами, но с [некоторыми отличиями в поддержке](https://caniuse.com/async-clipboard).

### Почему работа с буфером обмена важна для сайтов

Кажется, что такие знакомые сочетания клавиш как `Ctrl+C` и `Ctrl+V` знакомы каждому. Но пользователю иногда все-таки легче кликнуть по кнопке и получить содержимое в буфере обмена. Например, если пользователь хочет скопировать ссылку, то сочетания клавиш не помогают и нужно совершить больше действий, чтобы получить ее. Прямо как на сайте [web-standarts.ru](http://web-standarts.ru) — вы можете скопировать ссылку на конкретное место в статье, обозначенное подзаголовком, кликнув на иконку ссылки справа от заголовка. Так же, например, когда вы точно знаете, что размещённые данные будут использоваться в другом месте и знаете, что пользователь будет их копировать, тогда UX вашего сайта может быть улучшен простым добавлением этой кнопки и вы делаете удобный интерфейс для такого типа данных.

## Возможности современных браузеров

Современный API позволяет работать не только с текстом, но и со вставкой картинок, а также копировать смешанный контент или исключать какие-то элементы при попытке копирования с сайта. Есть несколько мест, в которых можно заметить методы, которые реализуют всю работу с Clipboard API.

Одно из самых главных мест — это API для чтения и записи в буфер обмена. Оно реализуется с помощью методов в `window.navigator.clipboard`, которые предоставляют прямой доступ к чтению или записи данных в буфер обмена. Также есть другие возможности, которые мы рассмотрим далее.

### Запись в буфер обмена

Для сохранения данных в буфер можно использовать `write()` или если мы собираемся помещать в буфер только текст — `writeText()`. Оба метода являются асинхронными и возвращают `Promise`

Рассмотрим простой пример с копированием ссылки:

```html
<span class="tooltip">
    <button
        class="tooltip__button"
        aria-label="Копировать ссылку на заголовок"
        data-href="#section-2"
        aria-labelledby="copy-section-2"
    ></button>
    <span class="tooltip__label" role="tooltip" id="copy-section-2"
        >Скопировать ссылку</span
    >
</span>
```

```jsx
document.querySelector(".tooltip").addEventListener("click", () => {
    const tooltip = this.nextSibling;
    const hash = this.getAttribute("data-href");

    navigator.clipboard
        .writeText(`${window.location.href}${hash}`)
        .then(() => {
            setSuccessState(tooltip);
        })
        .catch(() => {
            setErrorState(tooltip);
        });
});
```

[Полный пример кода на GitHub](https://github.com/web-standards-ru/web-standards.ru/blob/master/src/scripts/modules/copy-link.js)

Так как `writeText` возвращает `Promise`, мы должны обработать исключение, и в случае возникновения ошибки предупредить пользователя об этом.

Если мы используем функцию `write`, то к копируемым данным можно добавить, например, картинку. Как показано в примере:

```jsx
const blob = await fetch("http://placehold.jp/150x150.png").then((req) =>
    req.blob()
);
const clipboardItem = new ClipboardItem({ [blob.type]: blob });

navigator.clipboard
    .write([clipboardItem])
    .then(() => console.log("Image is copied!"))
    .catch((err) => console.error(err));
```

Также можно изменять данные перед записью в буфер обмена, когда пользователь пытается скопировать контент на странице, например, добавлять дополнительную информацию в копируемый контент:

```jsx
document.addEventListener("copy", (evt) => {
    const source = `Источник: ${window.location.href}`;

    // Нужно заблокировать стандартное поведение
    evt.preventDefault();
    // И поместить дополнительные данные в Clipboard
    evt.clipboardData.setData(
        "text",
        `${document.getSelection()}\n\n${source}`
    );
});
```

### Чтение буфера обмена

По аналогии с записью в буфер обмена мы можем читать данные из него. Для этого существуют аналогичные методы `read` и `readText`:

```jsx
navigator.clipboard
    .readText()
    .then((data) => console.log("Скопировано", data))
    .catch((err) => console.error("Не удалось скопировать", err));
```

Важной особенностью чтения из буфера обмена является то, что оно работает не напрямую. То есть, например, в Google Chrome во время попытки прочитать данные из буфера пользователь будет уведомлен о попытке, и ему будет предложено разрешить или запретить данное действие. А Safari, например, покажет контекстное меню с пунктом "Paste".

Также можно запросить разрешение на чтение буфера заранее с помощью [Permissions API](https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API) (нужно заметить, что не все браузеры его поддерживают).

Другой вариант чтения данных из буфера может быть на событии вставки данных на сайте. Один из таких случаев — это когда пользователь пытается вставить данные на сайте. Такое событие можно слушать как на `document`, так и, например, на `textarea`. С помощью этого метода можно перехватывать и обрабатывать события.

```jsx
document.querySelector("textarea").addEventListener("paste", (evt) => {
    if (evt.clipboardData.files.lenght === 0) {
        return;
    }
    const files = Array.from(evt.clipboardData.files);
    evt.preventDefault();
    uploadFiles(files)
        .then(() => console.log("Загружено!"))
        .catch((err) => console.error("Произошла ошибка", err));
});
```

### Заключение

Правильное использование современных API может значительно улучшить пользовательский опыт в вашем проекте. Clipboard API — один из таких случаев, когда вы можете облегчить взаимодействие с интерфейсом.
